{% extends 'base.html' %}
{% load static %}

{% block title %}Hiragana Flashcards - Nihonow{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="font-family: 'Noto Sans Japanese', sans-serif;">
    <h2 class="text-center mb-4" style="color: #d32f2f; font-size: 2.5rem;">Hiragana Flashcards</h2>

    <!-- Selection Section -->
    <div id="selection-section" class="text-center" style="background: linear-gradient(135deg, #ff9a9e, #fad0c4); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <p style="font-size: 1.5rem; color: #fff;">Choose your practice set:</p>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('basic')">Basic Hiragana</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('combinations')">Combinations</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('tenten')">Tenten/Dakuten</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('all')">All</button>
    </div>

    <!-- Timer Section -->
    <div id="timer-section" class="text-center" style="display: none; background: linear-gradient(135deg, #ff9a9e, #fad0c4); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <p id="timer-message" style="font-size: 1.5rem; color: #fff;">Getting flashcards ready...</p>
        <p id="timer" style="font-size: 2rem; color: #fff;">3</p>
    </div>

    <!-- Flashcard Section -->
    <div id="flashcard-section" class="text-center mt-4" style="display: none; background: linear-gradient(135deg, #ff9a9e, #fad0c4); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <h3 id="flashcard-char" style="font-size: 3rem; color: #fff;"></h3>
        <p style="font-size: 1.2rem; color: #fff;">Choose the correct reading:</p>
        <div id="options" class="d-flex justify-content-center flex-wrap gap-2"></div>
        <p id="result" class="mt-3" style="font-size: 1.5rem;"></p>
        <button id="next-btn" class="btn btn-light mt-3" style="display: none;">Next</button>
        <div class="progress mt-3" style="height: 20px;">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="background-color: #d32f2f; transition: width 0.3s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Score Section -->
    <div id="score-section" class="text-center mt-4" style="display: none; background: linear-gradient(135deg, #ff9a9e, #fad0c4); padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
        <p style="font-size: 1.2rem; color: #fff;">Score: <span id="score">0</span> / <span id="total">0</span></p>
    </div>
</div>

<script>
    // Hiragana data
    const hiraganaData = {
        basic: [
            { char: 'あ', reading: 'a' }, { char: 'い', reading: 'i' }, { char: 'う', reading: 'u' }, { char: 'え', reading: 'e' }, { char: 'お', reading: 'o' },
            { char: 'か', reading: 'ka' }, { char: 'き', reading: 'ki' }, { char: 'く', reading: 'ku' }, { char: 'け', reading: 'ke' }, { char: 'こ', reading: 'ko' },
            { char: 'さ', reading: 'sa' }, { char: 'し', reading: 'shi' }, { char: 'す', reading: 'su' }, { char: 'せ', reading: 'se' }, { char: 'そ', reading: 'so' },
            { char: 'た', reading: 'ta' }, { char: 'ち', reading: 'chi' }, { char: 'つ', reading: 'tsu' }, { char: 'て', reading: 'te' }, { char: 'と', reading: 'to' },
            { char: 'な', reading: 'na' }, { char: 'に', reading: 'ni' }, { char: 'ぬ', reading: 'nu' }, { char: 'ね', reading: 'ne' }, { char: 'の', reading: 'no' },
            { char: 'は', reading: 'ha' }, { char: 'ひ', reading: 'hi' }, { char: 'ふ', reading: 'fu' }, { char: 'へ', reading: 'he' }, { char: 'ほ', reading: 'ho' },
            { char: 'ま', reading: 'ma' }, { char: 'み', reading: 'mi' }, { char: 'む', reading: 'mu' }, { char: 'め', reading: 'me' }, { char: 'も', reading: 'mo' },
            { char: 'や', reading: 'ya' }, { char: 'ゆ', reading: 'yu' }, { char: 'よ', reading: 'yo' },
            { char: 'ら', reading: 'ra' }, { char: 'り', reading: 'ri' }, { char: 'る', reading: 'ru' }, { char: 'れ', reading: 're' }, { char: 'ろ', reading: 'ro' },
            { char: 'わ', reading: 'wa' }, { char: 'を', reading: 'wo' }, { char: 'ん', reading: 'n' }
        ],
        tenten: [
            { char: 'が', reading: 'ga' }, { char: 'ぎ', reading: 'gi' }, { char: 'ぐ', reading: 'gu' }, { char: 'げ', reading: 'ge' }, { char: 'ご', reading: 'go' },
            { char: 'ざ', reading: 'za' }, { char: 'じ', reading: 'ji' }, { char: 'ず', reading: 'zu' }, { char: 'ぜ', reading: 'ze' }, { char: 'ぞ', reading: 'zo' },
            { char: 'だ', reading: 'da' }, { char: 'ぢ', reading: 'ji' }, { char: 'づ', reading: 'zu' }, { char: 'で', reading: 'de' }, { char: 'ど', reading: 'do' },
            { char: 'ば', reading: 'ba' }, { char: 'び', reading: 'bi' }, { char: 'ぶ', reading: 'bu' }, { char: 'べ', reading: 'be' }, { char: 'ぼ', reading: 'bo' },
            { char: 'ぱ', reading: 'pa' }, { char: 'ぴ', reading: 'pi' }, { char: 'ぷ', reading: 'pu' }, { char: 'ぺ', reading: 'pe' }, { char: 'ぽ', reading: 'po' }
        ],
        combinations: [
            { char: 'きゃ', reading: 'kya' }, { char: 'きゅ', reading: 'kyu' }, { char: 'きょ', reading: 'kyo' },
            { char: 'しゃ', reading: 'sha' }, { char: 'しゅ', reading: 'shu' }, { char: 'しょ', reading: 'sho' },
            { char: 'ちゃ', reading: 'cha' }, { char: 'ちゅ', reading: 'chu' }, { char: 'ちょ', reading: 'cho' },
            { char: 'にゃ', reading: 'nya' }, { char: 'にゅ', reading: 'nyu' }, { char: 'にょ', reading: 'nyo' },
            { char: 'ひゃ', reading: 'hya' }, { char: 'ひゅ', reading: 'hyu' }, { char: 'ひょ', reading: 'hyo' },
            { char: 'みゃ', reading: 'mya' }, { char: 'みゅ', reading: 'myu' }, { char: 'みょ', reading: 'myo' },
            { char: 'りゃ', reading: 'rya' }, { char: 'りゅ', reading: 'ryu' }, { char: 'りょ', reading: 'ryo' },
            { char: 'ぎゃ', reading: 'gya' }, { char: 'ぎゅ', reading: 'gyu' }, { char: 'ぎょ', reading: 'gyo' },
            { char: 'じゃ', reading: 'ja' }, { char: 'じゅ', reading: 'ju' }, { char: 'じょ', reading: 'jo' },
            { char: 'びゃ', reading: 'bya' }, { char: 'びゅ', reading: 'byu' }, { char: 'びょ', reading: 'byo' },
            { char: 'ぴゃ', reading: 'pya' }, { char: 'ぴゅ', reading: 'pyu' }, { char: 'ぴょ', reading: 'pyo' }
        ]
    };

    let shuffledData = [];
    let currentIndex = 0;
    let score = 0;
    let total = 0;
    let answered = false;

    // Elements
    const selectionSection = document.getElementById('selection-section');
    const timerSection = document.getElementById('timer-section');
    const flashcardSection = document.getElementById('flashcard-section');
    const scoreSection = document.getElementById('score-section');
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');

    function startFlashcards(set) {
        // Filter data based on selection
        if (set === 'basic') shuffledData = [...hiraganaData.basic];
        else if (set === 'tenten') shuffledData = [...hiraganaData.tenten];
        else if (set === 'combinations') shuffledData = [...hiraganaData.combinations];
        else shuffledData = [...hiraganaData.basic, ...hiraganaData.tenten, ...hiraganaData.combinations];

        // Shuffle the selected set
        shuffledData.sort(() => 0.5 - Math.random());
        total = shuffledData.length;

        // Show score immediately with total
        scoreSection.style.display = 'block';
        document.getElementById('score').textContent = score;
        document.getElementById('total').textContent = total;

        // Hide selection, show timer
        selectionSection.style.display = 'none';
        timerSection.style.display = 'block';

        // Start timer
        let timeLeft = 3;
        const countdown = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                timerSection.style.display = 'none';
                flashcardSection.style.display = 'block';
                showFlashcard();
            }
        }, 1000);
    }

    function showFlashcard() {
        if (currentIndex >= shuffledData.length) {
            document.getElementById('flashcard-char').textContent = 'Finished!';
            document.getElementById('options').innerHTML = '';
            document.getElementById('result').textContent = 'Well done!';
            document.getElementById('next-btn').style.display = 'none';
            progressBar.style.width = '100%';
            return;
        }

        const currentChar = shuffledData[currentIndex];
        document.getElementById('flashcard-char').textContent = currentChar.char;
        document.getElementById('result').textContent = '';
        document.getElementById('next-btn').style.display = 'none';
        answered = false;

        // Update progress
        const progress = ((currentIndex + 1) / shuffledData.length) * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);

        // Generate options
        const optionsContainer = document.getElementById('options');
        optionsContainer.innerHTML = '';
        const correctReading = currentChar.reading;
        const allReadings = shuffledData.map(item => item.reading);
        const wrongOptions = allReadings.filter(r => r !== correctReading).sort(() => 0.5 - Math.random()).slice(0, 3);
        const options = [...wrongOptions, correctReading].sort(() => 0.5 - Math.random());

        options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-light';
            btn.textContent = option;
            btn.onclick = () => checkAnswer(option, correctReading);
            optionsContainer.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct) {
        if (answered) return; // Prevent multiple clicks
        answered = true;

        const resultElement = document.getElementById('result');
        if (selected === correct) {
            score++;
            resultElement.textContent = 'Correct!';
            resultElement.style.color = '#28a745';
        } else {
            resultElement.textContent = `Wrong! Correct answer: ${correct}`;
            resultElement.style.color = '#dc3545';
        }

        // Update score
        document.getElementById('score').textContent = score;
        document.getElementById('total').textContent = total;

        // Disable all buttons
        const buttons = document.getElementById('options').getElementsByTagName('button');
        for (let btn of buttons) {
            btn.disabled = true;
        }

        document.getElementById('next-btn').style.display = 'inline-block';
    }

    document.getElementById('next-btn').onclick = () => {
        currentIndex++;
        showFlashcard();
    };
</script>
{% endblock %}