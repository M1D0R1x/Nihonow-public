{% extends 'base.html' %}
{% load static %}

{% block title %}Katakana Flashcards - Nihonow{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="font-family: 'Noto Sans Japanese', sans-serif;">
    <h2 class="text-center mb-4" style="color: #1976d2; font-size: 2.5rem;">Katakana Flashcards</h2>

    <!-- Selection Section -->
    <div id="selection-section" class="text-center" style="background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <p style="font-size: 1.5rem; color: #fff;">Choose your practice set:</p>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('basic')">Basic Katakana</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('combinations')">Combinations</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('tenten')">Tenten/Dakuten</button>
        <button class="btn btn-outline-light m-2" onclick="startFlashcards('all')">All</button>
    </div>

    <!-- Timer Section -->
    <div id="timer-section" class="text-center" style="display: none; background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <p id="timer-message" style="font-size: 1.5rem; color: #fff;">Getting flashcards ready...</p>
        <p id="timer" style="font-size: 2rem; color: #fff;">3</p>
    </div>

    <!-- Flashcard Section -->
    <div id="flashcard-section" class="text-center mt-4" style="display: none; background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <h3 id="flashcard-char" style="font-size: 3rem; color: #fff;"></h3>
        <p style="font-size: 1.2rem; color: #fff;">Choose the correct reading:</p>
        <div id="options" class="d-flex justify-content-center flex-wrap gap-2"></div>
        <p id="result" class="mt-3" style="font-size: 1.5rem;"></p>
        <button id="next-btn" class="btn btn-light mt-3" style="display: none;">Next</button>
        <div class="progress mt-3" style="height: 20px;">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="background-color: #1976d2; transition: width 0.3s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Score Section -->
    <div id="score-section" class="text-center mt-4" style="display: none; background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
        <p style="font-size: 1.2rem; color: #fff;">Score: <span id="score">0</span> / <span id="total">0</span></p>
    </div>
</div>

<script>
    // Katakana data
    const katakanaData = {
        basic: [
            { char: 'ア', reading: 'a' }, { char: 'イ', reading: 'i' }, { char: 'ウ', reading: 'u' }, { char: 'エ', reading: 'e' }, { char: 'オ', reading: 'o' },
            { char: 'カ', reading: 'ka' }, { char: 'キ', reading: 'ki' }, { char: 'ク', reading: 'ku' }, { char: 'ケ', reading: 'ke' }, { char: 'コ', reading: 'ko' },
            { char: 'サ', reading: 'sa' }, { char: 'シ', reading: 'shi' }, { char: 'ス', reading: 'su' }, { char: 'セ', reading: 'se' }, { char: 'ソ', reading: 'so' },
            { char: 'タ', reading: 'ta' }, { char: 'チ', reading: 'chi' }, { char: 'ツ', reading: 'tsu' }, { char: 'テ', reading: 'te' }, { char: 'ト', reading: 'to' },
            { char: 'ナ', reading: 'na' }, { char: 'ニ', reading: 'ni' }, { char: 'ヌ', reading: 'nu' }, { char: 'ネ', reading: 'ne' }, { char: 'ノ', reading: 'no' },
            { char: 'ハ', reading: 'ha' }, { char: 'ヒ', reading: 'hi' }, { char: 'フ', reading: 'fu' }, { char: 'ヘ', reading: 'he' }, { char: 'ホ', reading: 'ho' },
            { char: 'マ', reading: 'ma' }, { char: 'ミ', reading: 'mi' }, { char: 'ム', reading: 'mu' }, { char: 'メ', reading: 'me' }, { char: 'モ', reading: 'mo' },
            { char: 'ヤ', reading: 'ya' }, { char: 'ユ', reading: 'yu' }, { char: 'ヨ', reading: 'yo' },
            { char: 'ラ', reading: 'ra' }, { char: 'リ', reading: 'ri' }, { char: 'ル', reading: 'ru' }, { char: 'レ', reading: 're' }, { char: 'ロ', reading: 'ro' },
            { char: 'ワ', reading: 'wa' }, { char: 'ヲ', reading: 'wo' }, { char: 'ン', reading: 'n' }
        ],
        tenten: [
            { char: 'ガ', reading: 'ga' }, { char: 'ギ', reading: 'gi' }, { char: 'グ', reading: 'gu' }, { char: 'ゲ', reading: 'ge' }, { char: 'ゴ', reading: 'go' },
            { char: 'ザ', reading: 'za' }, { char: 'ジ', reading: 'ji' }, { char: 'ズ', reading: 'zu' }, { char: 'ゼ', reading: 'ze' }, { char: 'ゾ', reading: 'zo' },
            { char: 'ダ', reading: 'da' }, { char: 'ヂ', reading: 'ji' }, { char: 'ヅ', reading: 'zu' }, { char: 'デ', reading: 'de' }, { char: 'ド', reading: 'do' },
            { char: 'バ', reading: 'ba' }, { char: 'ビ', reading: 'bi' }, { char: 'ブ', reading: 'bu' }, { char: 'ベ', reading: 'be' }, { char: 'ボ', reading: 'bo' },
            { char: 'パ', reading: 'pa' }, { char: 'ピ', reading: 'pi' }, { char: 'プ', reading: 'pu' }, { char: 'ペ', reading: 'pe' }, { char: 'ポ', reading: 'po' }
        ],
        combinations: [
            { char: 'キャ', reading: 'kya' }, { char: 'キュ', reading: 'kyu' }, { char: 'キョ', reading: 'kyo' },
            { char: 'シャ', reading: 'sha' }, { char: 'シュ', reading: 'shu' }, { char: 'ショ', reading: 'sho' },
            { char: 'チャ', reading: 'cha' }, { char: 'チュ', reading: 'chu' }, { char: 'チョ', reading: 'cho' },
            { char: 'ニャ', reading: 'nya' }, { char: 'ニュ', reading: 'nyu' }, { char: 'ニョ', reading: 'nyo' },
            { char: 'ヒャ', reading: 'hya' }, { char: 'ヒュ', reading: 'hyu' }, { char: 'ヒョ', reading: 'hyo' },
            { char: 'ミャ', reading: 'mya' }, { char: 'ミュ', reading: 'myu' }, { char: 'ミョ', reading: 'myo' },
            { char: 'リャ', reading: 'rya' }, { char: 'リュ', reading: 'ryu' }, { char: 'リョ', reading: 'ryo' },
            { char: 'ギャ', reading: 'gya' }, { char: 'ギュ', reading: 'gyu' }, { char: 'ギョ', reading: 'gyo' },
            { char: 'ジャ', reading: 'ja' }, { char: 'ジュ', reading: 'ju' }, { char: 'ジョ', reading: 'jo' },
            { char: 'ビャ', reading: 'bya' }, { char: 'ビュ', reading: 'byu' }, { char: 'ビョ', reading: 'byo' },
            { char: 'ピャ', reading: 'pya' }, { char: 'ピュ', reading: 'pyu' }, { char: 'ピョ', reading: 'pyo' }
        ]
    };

    let shuffledData = [];
    let currentIndex = 0;
    let score = 0;
    let total = 0;
    let answered = false;

    // Elements
    const selectionSection = document.getElementById('selection-section');
    const timerSection = document.getElementById('timer-section');
    const flashcardSection = document.getElementById('flashcard-section');
    const scoreSection = document.getElementById('score-section');
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('progress-bar');

    function startFlashcards(set) {
        // Filter data based on selection
        if (set === 'basic') shuffledData = [...katakanaData.basic];
        else if (set === 'tenten') shuffledData = [...katakanaData.tenten];
        else if (set === 'combinations') shuffledData = [...katakanaData.combinations];
        else shuffledData = [...katakanaData.basic, ...katakanaData.tenten, ...katakanaData.combinations];

        // Shuffle the selected set
        shuffledData.sort(() => 0.5 - Math.random());
        total = shuffledData.length;

        // Show score immediately with total
        scoreSection.style.display = 'block';
        document.getElementById('score').textContent = score;
        document.getElementById('total').textContent = total;

        // Hide selection, show timer
        selectionSection.style.display = 'none';
        timerSection.style.display = 'block';

        // Start timer
        let timeLeft = 3;
        const countdown = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                timerSection.style.display = 'none';
                flashcardSection.style.display = 'block';
                showFlashcard();
            }
        }, 1000);
    }

    function showFlashcard() {
        if (currentIndex >= shuffledData.length) {
            document.getElementById('flashcard-char').textContent = 'Finished!';
            document.getElementById('options').innerHTML = '';
            document.getElementById('result').textContent = 'Well done!';
            document.getElementById('next-btn').style.display = 'none';
            progressBar.style.width = '100%';
            return;
        }

        const currentChar = shuffledData[currentIndex];
        document.getElementById('flashcard-char').textContent = currentChar.char;
        document.getElementById('result').textContent = '';
        document.getElementById('next-btn').style.display = 'none';
        answered = false;

        // Update progress
        const progress = ((currentIndex + 1) / shuffledData.length) * 100;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);

        // Generate options
        const optionsContainer = document.getElementById('options');
        optionsContainer.innerHTML = '';
        const correctReading = currentChar.reading;
        const allReadings = shuffledData.map(item => item.reading);
        const wrongOptions = allReadings.filter(r => r !== correctReading).sort(() => 0.5 - Math.random()).slice(0, 3);
        const options = [...wrongOptions, correctReading].sort(() => 0.5 - Math.random());

        options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-light';
            btn.textContent = option;
            btn.onclick = () => checkAnswer(option, correctReading);
            optionsContainer.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct) {
        if (answered) return; // Prevent multiple clicks
        answered = true;

        const resultElement = document.getElementById('result');
        if (selected === correct) {
            score++;
            resultElement.textContent = 'Correct!';
            resultElement.style.color = '#28a745';
        } else {
            resultElement.textContent = `Wrong! Correct answer: ${correct}`;
            resultElement.style.color = '#dc3545';
        }

        // Update score
        document.getElementById('score').textContent = score;
        document.getElementById('total').textContent = total;

        // Disable all buttons
        const buttons = document.getElementById('options').getElementsByTagName('button');
        for (let btn of buttons) {
            btn.disabled = true;
        }

        document.getElementById('next-btn').style.display = 'inline-block';
    }

    document.getElementById('next-btn').onclick = () => {
        currentIndex++;
        showFlashcard();
    };
</script>
{% endblock %}