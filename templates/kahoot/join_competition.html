{% extends 'base.html' %}
{% block title %}Join Flashcard Dojo - Nihonow{% endblock %}
{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4" style="color: #00796b; font-size: 2.5rem;">Join a Flashcard Dojo</h2>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #b2dfdb, #e0f7fa);">
                <div class="card-body">
                    <form id="join-form">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="code" class="form-label" style="color: #00796b;">Enter Competition Code:</label>
                            <input type="text" name="code" id="code" class="form-control" placeholder="e.g., A1B2C3" required>
                        </div>
                        <div class="text-center">
                            <button type="submit" id="join-btn" class="btn btn-lg" style="background-color: #00796b; color: white;">Join</button>
                        </div>
                    </form>
                    <p id="error-message" class="text-center mt-3" style="color: red; display: none;"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('join-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const joinBtn = document.getElementById('join-btn');
        const code = document.getElementById('code').value.toUpperCase();
        const errorMsg = document.getElementById('error-message');

        if (!code) {
            showError('Please enter a competition code.');
            return;
        }

        joinBtn.disabled = true;
        joinBtn.innerText = 'Joining...';
        errorMsg.style.display = 'none';

        fetch('/api/join-competition/', {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            joinBtn.disabled = false;
            joinBtn.innerText = 'Join';
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                showError(data.error || 'An error occurred.');
            }
        })
        .catch(error => {
            joinBtn.disabled = false;
            joinBtn.innerText = 'Join';
            showError('An error occurred. Please try again.');
            console.error('Join error:', error);
        });
    });

    function showError(message) {
        const errorMsg = document.getElementById('error-message');
        errorMsg.innerText = message;
        errorMsg.style.display = 'block';
        setTimeout(() => errorMsg.style.display = 'none', 5000);
    }
</script>
{% endblock %}