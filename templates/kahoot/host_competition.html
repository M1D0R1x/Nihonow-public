{% extends 'base.html' %}
{% block title %}Host Flashcard Dojo - Nihonow{% endblock %}
{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4" style="color: #00796b; font-size: 2.5rem;">Host a Flashcard Dojo</h2>
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #b2dfdb, #e0f7fa);">
                <div class="card-body">
                    <form id="host-form">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="deck" class="form-label" style="color: #00796b;">Deck:</label>
                            <select name="deck" id="deck" class="form-control" onchange="updateSubtypes()">
                                <option value="hiragana">Hiragana</option>
                                <option value="katakana">Katakana</option>
                                <option value="kanji">Kanji</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="subtype" class="form-label" style="color: #00796b;">Subtype:</label>
                            <select name="subtype" id="subtype" class="form-control"></select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="timer_minutes" class="form-label" style="color: #00796b;">Timer (minutes, optional):</label>
                            <input type="number" name="timer_minutes" id="timer_minutes" class="form-control" min="1" placeholder="No timer">
                        </div>
                        <div class="text-center">
                            <button type="submit" id="create-btn" class="btn btn-lg" style="background-color: #00796b; color: white;">Create</button>
                        </div>
                    </form>
                    <p id="error-message" class="text-center mt-3" style="color: red; display: none;"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const decks = {
        'hiragana': ['basic_hiragana', 'combinations', 'tenten_dakuten', 'all_hiragana'],
        'katakana': ['basic_katakana', 'combinations', 'tenten_dakuten', 'all_katakana'],
        'kanji': ['numbers', 'environment', 'people', 'directions', 'verbs', 'adjectives', 'misc', 'all_kanji']
    };

    function updateSubtypes() {
        const deck = document.getElementById('deck').value;
        const subtypeSelect = document.getElementById('subtype');
        subtypeSelect.innerHTML = '';
        decks[deck].forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.text = sub.replace(/_/g, ' ').replace('all ', '').toUpperCase();
            subtypeSelect.appendChild(option);
        });
    }

    document.getElementById('host-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const createBtn = document.getElementById('create-btn');
        const timer = document.getElementById('timer_minutes').value;
        const errorMsg = document.getElementById('error-message');

        if (timer && timer < 1) {
            showError('Timer must be at least 1 minute.');
            return;
        }

        createBtn.disabled = true;
        createBtn.innerText = 'Creating...';
        errorMsg.style.display = 'none';

        fetch('/api/competition/host/', {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            createBtn.disabled = false;
            createBtn.innerText = 'Create';
            if (data.competition_id) {
                window.location.href = `/api/competition/${data.competition_id}/`;
            } else {
                showError(data.error || 'An error occurred.');
            }
        })
        .catch(error => {
            createBtn.disabled = false;
            createBtn.innerText = 'Create';
            showError('An error occurred. Please try again.');
            console.error('Host error:', error);
        });
    });

    function showError(message) {
        const errorMsg = document.getElementById('error-message');
        errorMsg.innerText = message;
        errorMsg.style.display = 'block';
        setTimeout(() => errorMsg.style.display = 'none', 5000);
    }

    updateSubtypes();
</script>
{% endblock %}